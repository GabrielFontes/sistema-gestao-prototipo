revoke delete on table "public"."empresa_members" from "anon";

revoke insert on table "public"."empresa_members" from "anon";

revoke references on table "public"."empresa_members" from "anon";

revoke select on table "public"."empresa_members" from "anon";

revoke trigger on table "public"."empresa_members" from "anon";

revoke truncate on table "public"."empresa_members" from "anon";

revoke update on table "public"."empresa_members" from "anon";

revoke delete on table "public"."empresa_members" from "authenticated";

revoke insert on table "public"."empresa_members" from "authenticated";

revoke references on table "public"."empresa_members" from "authenticated";

revoke select on table "public"."empresa_members" from "authenticated";

revoke trigger on table "public"."empresa_members" from "authenticated";

revoke truncate on table "public"."empresa_members" from "authenticated";

revoke update on table "public"."empresa_members" from "authenticated";

revoke delete on table "public"."empresa_members" from "service_role";

revoke insert on table "public"."empresa_members" from "service_role";

revoke references on table "public"."empresa_members" from "service_role";

revoke select on table "public"."empresa_members" from "service_role";

revoke trigger on table "public"."empresa_members" from "service_role";

revoke truncate on table "public"."empresa_members" from "service_role";

revoke update on table "public"."empresa_members" from "service_role";

revoke delete on table "public"."empresas" from "anon";

revoke insert on table "public"."empresas" from "anon";

revoke references on table "public"."empresas" from "anon";

revoke select on table "public"."empresas" from "anon";

revoke trigger on table "public"."empresas" from "anon";

revoke truncate on table "public"."empresas" from "anon";

revoke update on table "public"."empresas" from "anon";

revoke delete on table "public"."empresas" from "authenticated";

revoke insert on table "public"."empresas" from "authenticated";

revoke references on table "public"."empresas" from "authenticated";

revoke select on table "public"."empresas" from "authenticated";

revoke trigger on table "public"."empresas" from "authenticated";

revoke truncate on table "public"."empresas" from "authenticated";

revoke update on table "public"."empresas" from "authenticated";

revoke delete on table "public"."empresas" from "service_role";

revoke insert on table "public"."empresas" from "service_role";

revoke references on table "public"."empresas" from "service_role";

revoke select on table "public"."empresas" from "service_role";

revoke trigger on table "public"."empresas" from "service_role";

revoke truncate on table "public"."empresas" from "service_role";

revoke update on table "public"."empresas" from "service_role";

revoke delete on table "public"."key_results" from "anon";

revoke insert on table "public"."key_results" from "anon";

revoke references on table "public"."key_results" from "anon";

revoke select on table "public"."key_results" from "anon";

revoke trigger on table "public"."key_results" from "anon";

revoke truncate on table "public"."key_results" from "anon";

revoke update on table "public"."key_results" from "anon";

revoke delete on table "public"."key_results" from "authenticated";

revoke insert on table "public"."key_results" from "authenticated";

revoke references on table "public"."key_results" from "authenticated";

revoke select on table "public"."key_results" from "authenticated";

revoke trigger on table "public"."key_results" from "authenticated";

revoke truncate on table "public"."key_results" from "authenticated";

revoke update on table "public"."key_results" from "authenticated";

revoke delete on table "public"."key_results" from "service_role";

revoke insert on table "public"."key_results" from "service_role";

revoke references on table "public"."key_results" from "service_role";

revoke select on table "public"."key_results" from "service_role";

revoke trigger on table "public"."key_results" from "service_role";

revoke truncate on table "public"."key_results" from "service_role";

revoke update on table "public"."key_results" from "service_role";

revoke delete on table "public"."milestones" from "anon";

revoke insert on table "public"."milestones" from "anon";

revoke references on table "public"."milestones" from "anon";

revoke select on table "public"."milestones" from "anon";

revoke trigger on table "public"."milestones" from "anon";

revoke truncate on table "public"."milestones" from "anon";

revoke update on table "public"."milestones" from "anon";

revoke delete on table "public"."milestones" from "authenticated";

revoke insert on table "public"."milestones" from "authenticated";

revoke references on table "public"."milestones" from "authenticated";

revoke select on table "public"."milestones" from "authenticated";

revoke trigger on table "public"."milestones" from "authenticated";

revoke truncate on table "public"."milestones" from "authenticated";

revoke update on table "public"."milestones" from "authenticated";

revoke delete on table "public"."milestones" from "service_role";

revoke insert on table "public"."milestones" from "service_role";

revoke references on table "public"."milestones" from "service_role";

revoke select on table "public"."milestones" from "service_role";

revoke trigger on table "public"."milestones" from "service_role";

revoke truncate on table "public"."milestones" from "service_role";

revoke update on table "public"."milestones" from "service_role";

revoke delete on table "public"."objectives" from "anon";

revoke insert on table "public"."objectives" from "anon";

revoke references on table "public"."objectives" from "anon";

revoke select on table "public"."objectives" from "anon";

revoke trigger on table "public"."objectives" from "anon";

revoke truncate on table "public"."objectives" from "anon";

revoke update on table "public"."objectives" from "anon";

revoke delete on table "public"."objectives" from "authenticated";

revoke insert on table "public"."objectives" from "authenticated";

revoke references on table "public"."objectives" from "authenticated";

revoke select on table "public"."objectives" from "authenticated";

revoke trigger on table "public"."objectives" from "authenticated";

revoke truncate on table "public"."objectives" from "authenticated";

revoke update on table "public"."objectives" from "authenticated";

revoke delete on table "public"."objectives" from "service_role";

revoke insert on table "public"."objectives" from "service_role";

revoke references on table "public"."objectives" from "service_role";

revoke select on table "public"."objectives" from "service_role";

revoke trigger on table "public"."objectives" from "service_role";

revoke truncate on table "public"."objectives" from "service_role";

revoke update on table "public"."objectives" from "service_role";

revoke delete on table "public"."projects" from "anon";

revoke insert on table "public"."projects" from "anon";

revoke references on table "public"."projects" from "anon";

revoke select on table "public"."projects" from "anon";

revoke trigger on table "public"."projects" from "anon";

revoke truncate on table "public"."projects" from "anon";

revoke update on table "public"."projects" from "anon";

revoke delete on table "public"."projects" from "authenticated";

revoke insert on table "public"."projects" from "authenticated";

revoke references on table "public"."projects" from "authenticated";

revoke select on table "public"."projects" from "authenticated";

revoke trigger on table "public"."projects" from "authenticated";

revoke truncate on table "public"."projects" from "authenticated";

revoke update on table "public"."projects" from "authenticated";

revoke delete on table "public"."projects" from "service_role";

revoke insert on table "public"."projects" from "service_role";

revoke references on table "public"."projects" from "service_role";

revoke select on table "public"."projects" from "service_role";

revoke trigger on table "public"."projects" from "service_role";

revoke truncate on table "public"."projects" from "service_role";

revoke update on table "public"."projects" from "service_role";

revoke delete on table "public"."tasks" from "anon";

revoke insert on table "public"."tasks" from "anon";

revoke references on table "public"."tasks" from "anon";

revoke select on table "public"."tasks" from "anon";

revoke trigger on table "public"."tasks" from "anon";

revoke truncate on table "public"."tasks" from "anon";

revoke update on table "public"."tasks" from "anon";

revoke delete on table "public"."tasks" from "authenticated";

revoke insert on table "public"."tasks" from "authenticated";

revoke references on table "public"."tasks" from "authenticated";

revoke select on table "public"."tasks" from "authenticated";

revoke trigger on table "public"."tasks" from "authenticated";

revoke truncate on table "public"."tasks" from "authenticated";

revoke update on table "public"."tasks" from "authenticated";

revoke delete on table "public"."tasks" from "service_role";

revoke insert on table "public"."tasks" from "service_role";

revoke references on table "public"."tasks" from "service_role";

revoke select on table "public"."tasks" from "service_role";

revoke trigger on table "public"."tasks" from "service_role";

revoke truncate on table "public"."tasks" from "service_role";

revoke update on table "public"."tasks" from "service_role";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.gerar_slug_workspace()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  NEW.slug := lower(regexp_replace(NEW.name, '\s+', '-', 'g'));
  NEW.slug := regexp_replace(NEW.slug, '[^a-z0-9\-]', '', 'g');
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_empresa_members_with_details(p_empresa_id uuid)
 RETURNS TABLE(id uuid, user_id uuid, email text, display_name text, role text, created_at timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  IF NOT EXISTS (
    SELECT 1
    FROM empresa_members em
    WHERE em.empresa_id = p_empresa_id
      AND em.user_id = auth.uid()
  ) THEN
    RAISE EXCEPTION 'Access denied';
  END IF;

  RETURN QUERY
  SELECT 
    em.id,
    em.user_id,
    au.email::text,  -- 🔹 CONVERSÃO EXPLÍCITA
    COALESCE(
      au.raw_user_meta_data->>'display_name',
      au.raw_user_meta_data->>'full_name',
      au.email
    )::text AS display_name, -- 🔹 CONVERSÃO EXPLÍCITA
    em.role,
    em.created_at
  FROM empresa_members em
  JOIN auth.users au ON au.id = em.user_id
  WHERE em.empresa_id = p_empresa_id
  ORDER BY em.created_at;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.handle_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.is_owner_or_admin(p_user_id uuid, p_empresa_id uuid)
 RETURNS boolean
 LANGUAGE plpgsql
 STABLE SECURITY DEFINER
AS $function$
BEGIN
  RETURN EXISTS (
    SELECT 1
    FROM public.empresa_members em
    WHERE em.empresa_id = p_empresa_id
      AND em.user_id = p_user_id
      AND em.role IN ('owner', 'admin')
  );
END;
$function$
;



